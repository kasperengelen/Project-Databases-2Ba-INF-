{% extends 'layout.html' %}

{% block body %}
	<div class="jumbotron" style="padding: 1%;">
		<div class="row">
			<div class="col-sm-3 text-left">
				<a href="{{ url_for('dataset_pages.list_dataset') }}" class="btn btn-primary">Datasets</a>
				</br>
				</br>
				<a href="{{ url_for('dataset_pages.view_dataset_table_history', dataset_id=dataset_info.setid) }}" class="btn btn-primary">History</a>
			</div>
			<div class="col-sm-6 text-center">
				<h2>{{ dataset_info.name }}</h2>
				<p>{{ dataset_info.desc }}</p>
			</div>
			{% if perm_type == 'admin' %}
				<div class="col-sm-3 text-right">
					<div>
						{% include "includes/modals/_edit_dataset_modal.html" %}
						</br>
						</br>
						<a href="{{ url_for('dataset_pages.edit_perms_dataset', dataset_id=dataset_info.setid) }}" 
							class="btn btn-primary">Permissions</a>
					</div>
				</div>
			{% endif %}
		</div>
	</div>

	{% if (perm_type == 'admin' or perm_type == 'write') %}
		<div class="panel-group" id="accordion">
		    <div class="panel panel-default">
		      	<div class="panel-heading">
		        	<h4 class="panel-title">
		          		<a data-toggle="collapse" data-Hang onparent="#accordion" href="#add">Add Table</a>
		        	</h4>
		      	</div>
		      	<div id="add" class="panel-collapse collapse">
		        	<div class="panel-body">
		        		{% from "includes/_formhelpers.html" import render_field %}
						<form method="post" enctype="multipart/form-data" action="{{ url_for('dataset_pages.upload', 
						dataset_id=dataset_info.setid) }}">
							{{ uploadform.hidden_tag() }}
							<div class="form-group" style="width: 50%;">
	                 			{{render_field(uploadform.data_file, class_="form-control")}}  
	                		</div>
                            <div class="form-group" style="width: 50%;">
                                {{render_field(uploadform.columnnames_included, class_="checkbox-inline")}}  
	                		</div>
							<p><input type="submit" class="btn btn-primary" value="Upload File"></p>
						</form>
						<p>Allowed extensions: .csv, .zip, .dump, .sql</p>
		        	</div>
		      	</div>
		    </div>
			{% if table_list %}
			    <div class="panel panel-default">
			      	<div class="panel-heading">
			        	<h4 class="panel-title">
			         		<a data-toggle="collapse" data-parent="#accordion" href="#join">Join Tables</a>
			        	</h4>
			      	</div>
			      	<div id="join" class="panel-collapse collapse">
			        	<div class="panel-body">	
			        		<!-- JOIN FORM -->
			        		{% from "includes/_formhelpers.html" import render_field %}
		                    <form action="{{ url_for('dataset_pages.transform_join_tables', dataset_id=dataset_info.setid, tablename=table)}}" method="post" 
		                    	id="join">
		                        {{ join_form.hidden_tag() }}
		                    	<div class="form-group" style="width: 20%; display: inline-block;">
		                    		{{ render_field(join_form.tablename1, class_="form-control") }}
		                    	</div>
		                    	<div class="form-group" style="width: 20%; display: inline-block;">
		                    		{{ render_field(join_form.attribute1, class_="form-control") }}
		                    	</div>
		                    	<div class="form-group" style="width: 20%; display: inline-block;">
		                    		{{ render_field(join_form.tablename2, class_="form-control") }}
		                    	</div>
		                    	<div class="form-group" style="width: 20%; display: inline-block;">
		                    		{{ render_field(join_form.attribute2, class_="form-control") }}
		                    	</div>
		                    	<div class="form-group" style="width: 20%; display: inline-block;">
		                    		{{ render_field(join_form.newname, class_="form-control") }}
		                    	</div>
		                		<input style="display: inline-block;" id="join" class="btn btn-primary" type="submit" value="Join Tables">
		                    </form>
			        		<!-- JOIN FORM -->
			        	</div>
		     		</div>
		    	</div>
		    {% endif %}
	  	</div>		
	{% endif %}

    <div class="jumbotron">
    	<div style="overflow-x: auto;">
			<table>
				{% if table_list %}
					<tr>
						<th>Tables</th>
						<th></th>
						<th></th>
					</tr>

					{% for table in table_list %}
					<tr>
						<td><a href="{{ url_for('dataset_pages.view_dataset_table', dataset_id=dataset_info.setid, tablename=table) }}">
							{{ table }}</a></td>
						
						<td><a href="{{ url_for('dataset_pages.view_dataset_table_original', dataset_id=dataset_info.setid, tablename=table) }}">
							View Raw</a></td>

						<td><input type="hidden" id="input" value="delete this table?">
							<form method="post" action="{{ url_for('dataset_pages.delete_table', dataset_id=dataset_info.setid, tablename=table) }}"
										name="delete{{ table }}" onsubmit="return check()">
									<label for="delete{{ table }}" class="glyphicon glyphicon-remove"></label>
									<input href="" id="delete{{ table }}" style="visibility: hidden;" type="submit"></form></td>
					</tr>
					{% endfor %}
					
				{% endif %}
			</table>
		</div>
	</div>

	<script charset="utf-8" type="text/javascript">

		$(function() {

			var dropdown = {
				tablename1: $('#tablename1'),
				attribute1: $('#attribute1'),
				tablename2: $('#tablename2'),
				attribute2: $('#attribute2')
			};

			updateAttr1();
			updateAttr2();

			function updateAttr1() {
				var send = {
					tablename1: dropdown.tablename1.val()
				};
				dropdown.attribute1.attr('disabled', 'disabled');
				dropdown.attribute1.empty();
				$.getJSON("{{ url_for('dataset_pages._get_attr1_options', dataset_id=dataset_info.setid, tablename=table_name, info=send) }}", send, function(data) {
					data.forEach(function(item) {
						dropdown.attribute1.append (
							$('<option>', {
								value: item[0],
								text: item[1]
							})
						);
					});
					dropdown.attribute1.removeAttr('disabled');
				});
			}


			function updateAttr2() {
				var send = {
					tablename2: dropdown.tablename2.val()
				};
				dropdown.attribute2.empty();
				$.getJSON("{{ url_for('dataset_pages._get_attr2_options', dataset_id=dataset_info.setid, tablename=table_name, info=send) }}", send, function(data) {
					data.forEach(function(item) {
						dropdown.attribute2.append (
							$('<option>', {
								value: item[0],
								text: item[1]
							})
						);
					});
					dropdown.attribute2.removeAttr('disabled');
				});
			}

			
			$('#tablename1').change(function() {
				updateAttr1();
			});
			$('#tablename2').change(function() {
				updateAttr2();
			});
		});

	</script>

{% endblock %}
