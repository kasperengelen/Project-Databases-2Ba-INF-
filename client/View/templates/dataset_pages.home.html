{% extends 'layout.html' %}

{% block body %}
	<div class="jumbotron" style="padding: 1%;">
		<div class="row">
			<div class="col-sm-3 text-left">
				<a href="{{ url_for('dataset_pages.list') }}" class="btn btn-primary">
					<span class="glyphicon glyphicon-share-alt" style="-webkit-transform: scaleX(-1); transform: scaleX(-1);"></span></a>
				</br>
				</br>
				</br>
				<a href="{{ url_for('dataset_pages.history', dataset_id=dataset_info.setid) }}" class="btn btn-primary">History</a>
			</div>
			<div class="col-sm-6 text-center">
				<h2>{{ dataset_info.name }}</h2>
				<p>{{ dataset_info.desc }}</p>
			</div>
			{% if perm_type == 'admin' %}
				<div class="col-sm-3 text-right">
					<div>
						{% include "includes/modals/_edit_dataset_modal.html" %}
						</br>
						</br>
						</br>
						<a href="{{ url_for('dataset_pages.permissions', dataset_id=dataset_info.setid) }}" 
							class="btn btn-primary">Permissions</a>
					</div>
				</div>
			{% endif %}
		</div>
	</div>

	{% if (perm_type == 'admin' or perm_type == 'write') %}
		<div class="panel-group" id="accordion">
		    <div class="panel panel-default">
		      	<div class="panel-heading">
		        	<h4 class="panel-title">
		          		<a data-toggle="collapse" data-parent="#accordion" href="#add">Add Table</a>
		        	</h4>
		      	</div>
		      	<div id="add" class="panel-collapse collapse">
		        	<div class="panel-body">
		        		{% from "includes/_formhelpers.html" import render_field %}
						<form method="post" enctype="multipart/form-data" action="{{ url_for('dataset_pages.upload', 
						dataset_id=dataset_info.setid) }}">
							{{ uploadform.hidden_tag() }}
							<div class="form-group" style="width: 50%;">
	                 			{{render_field(uploadform.data_file, class_="form-control")}}  
	                		</div>
                            <div class="form-group" style="width: 50%;">
                                {{render_field(uploadform.columnnames_included, class_="checkbox-inline")}}  
	                		</div>
							<p><input type="submit" class="btn btn-primary" value="Upload File"></p>
						</form>
						<p>Allowed extensions: .csv, .zip, .dump, .sql</p>
		        	</div>
		      	</div>
		    </div>
			{% if table_list %}
			    <div class="panel panel-default">
			      	<div class="panel-heading">
			        	<h4 class="panel-title">
			         		<a data-toggle="collapse" data-parent="#accordion" href="#join">Join Tables</a>
			        	</h4>
			      	</div>
			      	<div id="join" class="panel-collapse collapse">
			        	<div class="panel-body">	
			        		<!-- JOIN FORM -->
			        		{% from "includes/_formhelpers.html" import render_field %}
		                    <form action="{{ url_for('dataset_pages.join_tables', dataset_id=dataset_info.setid, tablename=table)}}" method="post" 
		                    	id="join">
		                        {{ join_form.hidden_tag() }}
		                    	<div class="form-group" style="width: 20%; display: inline-block;">
		                    		{{ render_field(join_form.tablename1, class_="form-control") }}
		                    	</div>
		                    	<div class="form-group" style="width: 20%; display: inline-block;">
		                    		{{ render_field(join_form.attribute1, class_="form-control") }}
		                    	</div>
		                    	<div class="form-group" style="width: 20%; display: inline-block;">
		                    		{{ render_field(join_form.tablename2, class_="form-control") }}
		                    	</div>
		                    	<div class="form-group" style="width: 20%; display: inline-block;">
		                    		{{ render_field(join_form.attribute2, class_="form-control") }}
		                    	</div>
		                    	<div class="form-group" style="width: 20%; display: inline-block;">
		                    		{{ render_field(join_form.newname, class_="form-control") }}
		                    	</div>
		                		<input style="display: inline-block;" id="join" class="btn btn-primary" type="submit" value="Join Tables">
		                    </form>
			        		<!-- JOIN FORM -->
			        	</div>
		     		</div>
		    	</div>
		    {% endif %}
	  	</div>		
	{% endif %}


	<div style="overflow-x: auto;">
		<style>
	        table {
	            border-collapse: collapse;
	            float:left;
	            padding:3px;
	            border-radius: 3px;
	            }

	        td, th {
	            font-size: 15px;
	            text-align: left;
	            padding: 8px;
	            width: 25%;
	        }

	        table thead {
	            background-color: lightgrey;
	        }

	        table tbody tr:nth-child(even) {
	            background-color: #eaeaea;
	        }

	        .dataTables_filter {
	            display: none;
	        }
	    </style>
	    <div class="col-sm-6 col-sm-offset-3">
			<!-- TABLE LIST -->
		    <!-- NAV TABS -->
		    <ul class="nav nav-tabs" role="tablist">
		    	<li class="active"><a href="#activeTables" role="tab" data-toggle="tab">Active Tables</a></li>
		    	<li><a href="#originalTables" role="tab" data-toggle="tab">Original Tables</a></li>
		    </ul>

		    <!-- TAB PANES -->
		    <div class="tab-content">
				<div class="tab-pane active" id="activeTables">
				<table id="tabletable">
					<thead>
						<tr>
							<th>Tables</th>
							<th>Delete</th>
						</tr>
					</thead>
					<tbody>
					{% if table_list %}
						{% for table in table_list %}
						<tr>
							<td><a href="{{ url_for('dataset_pages.table', dataset_id=dataset_info.setid, tablename=table) }}">
								{{ table }}</a></td>
							<td><input type="hidden" id="input" value="delete this table?">
								<form method="post" action="{{ url_for('dataset_pages.delete_table', dataset_id=dataset_info.setid, tablename=table) }}"
											name="delete{{ table }}" onsubmit="return check()">
										<label for="delete{{ table }}" class="glyphicon glyphicon-remove"></label>
										<input href="" id="delete{{ table }}" style="visibility: hidden;" type="submit"></form></td>
						</tr>
						{% endfor %}
					{% endif %}
					</tbody>
				</table>
				</div>
				<div class="tab-pane" id="originalTables">
				<table id="originalstable" style="width: 580px;">
					<thead>
						<tr>
							<th>Tables</th>
						</tr>
					</thead>
					<tbody>
					{% if original_table_list %}
						{% for table in original_table_list %}
						<tr>
							<td><a href="{{ url_for('dataset_pages.table_original', dataset_id=dataset_info.setid, tablename=table) }}">
							{{ table }}</a></td>
						</tr>
						{% endfor %}
					{% endif %}
					</tbody>
				</table>
				</div>
			</div>
		</div>
		<script>
	        $(document).ready( function () {
	            $('#tabletable').DataTable( {
	                scrollX: true,
	                scrollY: true,
	                paging: false,
	                info: false,
	                lengthChange: false,
	                autoWidth: false,
	                columnDefs: [
	                	{"targets": 1, "orderable": false}
	                ]
	            } );
	        } );
	    </script>
	    <script>
	        $(document).ready( function () {
	            $('#originalstable').DataTable( {
	                scrollX: true,
	                scrollY: true,
	                paging: false,
	                lengthChange: false,
	                info: false,
	                autoWidth: false
	            } );
	        } );
	    </script>

	    <!-- TABLE LIST -->
	</div>

	<script charset="utf-8" type="text/javascript">

		$(function() {

			var dropdown = {
				tablename1: $('#tablename1'),
				attribute1: $('#attribute1'),
				tablename2: $('#tablename2'),
				attribute2: $('#attribute2')
			};

			updateAttr1();
			updateAttr2();

			function updateAttr1() {
				var send = {
					tablename1: dropdown.tablename1.val()
				};
				dropdown.attribute1.attr('disabled', 'disabled');
				dropdown.attribute1.empty();
				$.getJSON("{{ url_for('dataset_pages._get_attr1_options', dataset_id=dataset_info.setid, tablename=table_name, info=send) }}", send, function(data) {
					data.forEach(function(item) {
						dropdown.attribute1.append (
							$('<option>', {
								value: item[0],
								text: item[1]
							})
						);
					});
					dropdown.attribute1.removeAttr('disabled');
				});
			}


			function updateAttr2() {
				var send = {
					tablename2: dropdown.tablename2.val()
				};
				dropdown.attribute2.empty();
				$.getJSON("{{ url_for('dataset_pages._get_attr2_options', dataset_id=dataset_info.setid, tablename=table_name, info=send) }}", send, function(data) {
					data.forEach(function(item) {
						dropdown.attribute2.append (
							$('<option>', {
								value: item[0],
								text: item[1]
							})
						);
					});
					dropdown.attribute2.removeAttr('disabled');
				});
			}

			
			$('#tablename1').change(function() {
				updateAttr1();
			});
			$('#tablename2').change(function() {
				updateAttr2();
			});
		});

	</script>

{% endblock %}
