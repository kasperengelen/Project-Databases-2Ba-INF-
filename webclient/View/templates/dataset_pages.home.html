{% extends 'layout.html' %}

{% block body %}
	<div class="jumbotron" style="padding: 1%;">
		<div class="row">
			<div class="col-sm-3 text-left">
				<a href="{{ url_for('dataset_pages.list_dataset') }}" class="btn btn-primary">Datasets</a>
			</div>
			<div class="col-sm-6 text-center">
				<h2>{{ dataset_info.name }}</h2>
				<p>{{ dataset_info.desc }}</p>
			</div>
			{% if perm_type == 'admin' %}
				<div class="col-sm-3 text-right">
					<div>
						<a href="{{ url_for('dataset_pages.manage_dataset', dataset_id=dataset_info.setid) }}" 
							class="btn btn-primary">Manage</a>
						</br>
						</br>
						<a href="{{ url_for('dataset_pages.edit_perms_dataset', dataset_id=dataset_info.setid) }}" 
							class="btn btn-primary">Permissions</a>
					</div>
				</div>
			{% endif %}
		</div>
	</div>

	{% if (perm_type == 'admin' or perm_type == 'write') %}
		<div class="panel-group" id="accordion">
		    <div class="panel panel-default">
		      	<div class="panel-heading">
		        	<h4 class="panel-title">
		          		<a data-toggle="collapse" data-Hang onparent="#accordion" href="#add">Add Table</a>
		        	</h4>
		      	</div>
		      	<div id="add" class="panel-collapse collapse">
		        	<div class="panel-body">
		        		{% from "includes/_formhelpers.html" import render_field %}
						<form method="post" enctype="multipart/form-data" action="{{ url_for('dataset_pages.upload', 
						dataset_id=dataset_info.setid) }}">
							{{ form.hidden_tag() }}
							<div class="form-group" style="width: 50%;">
	                 			{{render_field(form.data_file, class_="form-control")}}  
	                		</div>
	                		<p style="display: inline-block;">Column names included? (Only CSV)     </p>
	                		<div class="form-group" style="display: inline-block;">
	                			{{ form.columnnames_included }}
	                		</div>
							<p><input type="submit" class="btn btn-primary" value="Upload File"></p>
						</form>
						<p>Allowed extensions: .csv, .zip, .dump, .sql</p>
		        	</div>
		      	</div>
		    </div>
		    <div class="panel panel-default">
		      	<div class="panel-heading">
		        	<h4 class="panel-title">
		         		<a data-toggle="collapse" data-parent="#accordion" href="#join">Join Tables</a>
		        	</h4>
		      	</div>
		      	<div id="join" class="panel-collapse collapse">
		        	<div class="panel-body">	
		        		{% from "includes/_formhelpers.html" import render_field %}
		      			<!-- Join Form -->
						<form method="post" action="{{ url_for('dataset_pages.transform_findreplace', dataset_id=dataset_info.setid, tablename=table_name) }}">
						{{ join_form.csrf_token }}
						<div class="form-group" style="width: 20%; display: inline-block;">
							{{render_field(join_form.tablename1, class_="form-control")}}
						</div>
						<div class="form-group" style="width: 20%; display: inline-block;">
							{{render_field(join_form.attribute1, class_="form-control", placeholder="Searchterm")}}
						</div>
						<div class="form-group" style="width: 20%; display: inline-block;">
							{{render_field(join_form.tablename2, class_="form-control", placeholder="Searchterm")}}
						</div>
						<div class="form-group" style="width: 20%; display: inline-block;">
							{{render_field(join_form.attribute2, class_="form-control", placeholder="Searchterm")}}
						</div>
						<p style="display: inline-block;"><input type="submit" id="join" class="btn btn-primary" value="Join Tables"></p>
						</form>
						<!-- Join Form -->
		        	</div>
	     		</div>
	    	</div>
	  	</div>		
	{% endif %}

    <div class="jumbotron">
    	<div style="overflow-x: auto;">
			<table>
				{% if table_list %}
					<tr>
						<th>Tables</th>
						<th></th>
					</tr>

					{% for table in table_list %}
					<tr>
						<td><a href="{{ url_for('dataset_pages.view_dataset_table', dataset_id=dataset_info.setid, tablename=table) }}">
							{{ table }}</a></td>
						<td><a id="file" href="#" data-toggle="modal" data-target="#downloadFormModal_{{ table }}">Export to CSV</a></td>
						<!-- Download dialog. -->
						<div id="downloadFormModal_{{ table }}" class="modal fade" role="dialog">
					        <div class="modal-dialog">
					        
					            <!-- Modal content-->
					            <div class="modal-content">
					                <div class="modal-header">
					                    <button type="button" class="close" data-dismiss="modal">&times;</button>
					                    <h4 class="modal-title">Download table.</h4>
					                </div>
					                <div class="modal-body">
					                	<!-- Download form -->
					                	{% from "includes/_formhelpers.html" import render_field %}
					                    <form action="{{ url_for('dataset_pages.download', dataset_id=dataset_info.setid, tablename=table)}}" method="get" 
					                    	id="downloadForm_{{ table }}">
                                            {{ downloadform.hidden_tag() }}
					                    	<div class="form-group">
					                    		{{ render_field(downloadform.delimiter, class_="form-control") }}
					                    	</div>
					                    	<div class="form-group">
					                    		{{ render_field(downloadform.quotechar, class_="form-control") }}
					                    	</div>
					                    	<div class="form-group">
					                    		{{ render_field(downloadform.nullrep, class_="form-control") }}
					                    	</div>
                                    		<input id="downloadForm_{{ table }}" class="btn btn-primary" type="submit" value="Download">
					                    </form>
					                    <!-- Download form -->
					                </div>
					                <div class="modal-footer">
					                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					                </div>
					            </div>
					            <!-- Modal content -->
					        </div>
						</div>
						<!-- Download dialog. -->
					</tr>
					{% endfor %}
					
				{% endif %}
			</table>
		</div>
	</div>

	<script charset="utf-8" type="text/javascript">

		$(function() {

			var dropdown = {
				tablename1: $('#tablename1'),
				attribute1: $('#attribute1'),
				tablename2: $('#tablename2'),
				attribute2: $('#attribute2')
			};

			updateAttr1();
			updateTable2();
			updateAttr2();

			function updateAttr1() {
				var send = {
					tablename1: dropdown.tablename1.val()
				};
				dropdown.attribute1.attr('disabled', 'disabled');
				dropdown.attribute1.empty();
				$.getJSON("{{ url_for('dataset_pages._get_attr1_options', dataset_id=dataset_info.setid, tablename=table_name, info=send) }}", send, function(data) {
					data.forEach(function(item) {
						dropdown.attribute1.append (
							$('<option>', {
								value: item[0],
								text: item[1]
							})
						);
					});
					dropdown.attribute1.removeAttr('disabled');
				});
			}

			function updateTable2() {
				var send = {
					tablename1: dropdown.tablename1.val()
				};
				dropdown.tablename2.attr('disabled', 'disabled');
				dropdown.tablename2.empty();
				$.getJSON("{{ url_for('dataset_pages._get_table2_options', dataset_id=dataset_info.setid, tablename=table_name, table=send) }}", send, function(data) {
					data.forEach(function(item) {
						dropdown.tablename2.append (
							$('<option>', {
								value: item[0],
								text: item[1]
							})
						);
					});
					dropdown.tablename2.removeAttr('disabled');
				});
			}

			function updateAttr2() {
				var send = {
					tablename2: dropdown.tablename2.val()
				};
				dropdown.attribute2.empty();
				$.getJSON("{{ url_for('dataset_pages._get_attr2_options', dataset_id=dataset_info.setid, tablename=table_name, info=send) }}", send, function(data) {
					data.forEach(function(item) {
						dropdown.attribute2.append (
							$('<option>', {
								value: item[0],
								text: item[1]
							})
						);
					});
					dropdown.attribute2.removeAttr('disabled');
				});
			}

			
			$('#tablename1').change(function() {
				updateAttr1();
				updateTable2();
				updateAttr2();
			});
			$('#tablename2').change(function() {
				updateAttr2();
			});
		});

	</script>

{% endblock %}
