{% extends 'layout.html' %}

{% block body %}
	<div class="jumbotron" style="padding: 1%;">
		<div class="row">
			<div class="col-sm-3 text-left">
				<a href="{{ url_for('dataset_pages.view_dataset_home', dataset_id=dataset_info.setid) }}"
				class="btn btn-primary">Tables</a>
			</div>
			<div class="col-sm-6 text-center">
				<h2>{{ dataset_info.name }}</h2>
				<p>{{ dataset_info.desc }}</p>
			</div>
		</div>
	</div>    		
  
  	<div class="panel-group" id="accordion">
	    <div class="panel panel-default">
	      	<div class="panel-heading">
	        	<h4 class="panel-title">
	          		<a data-toggle="collapse" data-parent="#accordion" href="#view">View</a>
	        	</h4>
	      	</div>
	      	<div id="view" class="panel-collapse collapse">
	        	<div class="panel-body">
	        		{% from "includes/_formhelpers.html" import render_field %}
	        		<table>
	        			{% if colstats %}
	        				<tr>
		        				<th>Attribute</th>
		        				<th>Average</th>
		        				<th>Minimum</th>
		        				<th>Maximum</th>
		        				<th>Null Frequency</th>
		        				<th>Most Frequent</th>
		        				<th></th>
	        				</tr>
	        				{% for col in colstats %}
	        					<tr>
			        				<td>{{ col.attr_name }}</td>
			        				<td>{{ col.avg }}</td>
			        				<td>{{ col.min }}</td>
			        				<td>{{ col.max }}</td>
			        				<td>{{ col.nullfreq }}</td>
			        				<td>{{ col.mostfreq }}</td>
		        					<td><a id="plot" href="#" data-toggle="modal" data-target="#plots_{{ col.attr_name }}">Show Plots</a></td>
			        			</tr>

			        			<div id="plots_{{ col.attr_name }}" class="modal fade" role="dialog">
							        <div class="modal-dialog">
							        
							            <!-- Modal content-->
							            <div class="modal-content">
							                <div class="modal-header">
							                    <button type="button" class="close" data-dismiss="modal">&times;</button>
							                    <h4 class="modal-title">Plots for {{ col.attr_name }}</h4>
							                </div>
							                <div class="modal-body">
							                	<div id="graphs"></div>
							                	<meta id="graph_url" content="{{ url_for('dataset_pages._get_graphs', dataset_id=dataset_info, tablename=table, attr_name=col.attr_name) }}">
							                	<script>
							                		function() {
							                			document.getElementById('#graphs').innerHTML = window.location.replace(document.getElementById('#graph_url'))
							                		}
							                	</script>
							                </div>
							                <div class="modal-footer">
							                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
							                </div>
							            </div>
							            <!-- Modal content -->
							        </div>
								</div>
	        				{% endfor %}
	        				<tr>

	        				</tr>
	        			{% endif %}
	        		</table>
	        	</div>
	      	</div>
	    </div>
	    {% if (perm_type == 'admin' or perm_type == 'write') %}
		    <div class="panel panel-default">
		      	<div class="panel-heading">
		        	<h4 class="panel-title">
		         		<a data-toggle="collapse" data-parent="#accordion" href="#transform">Transform</a>
		        	</h4>
		      	</div>
		      	<div id="transform" class="panel-collapse collapse">
		      		<div class="panel-body">
		      			{% from "includes/_formhelpers.html" import render_field %}

		      			<!-- Find & Replace -->
		      			<div class="col-sm-12" style="border-bottom: 1px solid lightgrey; overflow-x: auto;">
							<h5><u><strong>Find and Replace</strong></u></h5>
							<form method="post" action="{{ url_for('dataset_pages.transform_findreplace', dataset_id=dataset_info.setid, tablename=table_name) }}">
							{{ findrepl_form.csrf_token }}
							<div class="form-group" style="width: 20%; display: inline-block;">
								{{render_field(findrepl_form.select_attr, class_="form-control")}}
							</div>
							<div class="form-group" style="width: 30%; display: inline-block;">
								{{render_field(findrepl_form.search, class_="form-control", placeholder="Searchterm")}}
							</div>
							<div class="form-group" style="width: 30%; display: inline-block;">
								{{render_field(findrepl_form.replacement, class_="form-control", placeholder="Replacement")}}  
							</div>
							<p style="display: inline-block;"><input type="submit" id="findrepl" class="btn btn-primary" value="Find and Replace"></p>
							<div class="form-group" style="width: 30%; display: inline-block;">
								{{render_field(findrepl_form.exactmatch, class_="checkbox-inline", placeholder="True")}}
							</div>
							<div class="form-group" style="width: 30%; display: inline-block;">
								{{render_field(findrepl_form.replace_full_match, class_="checkbox-inline", placeholder="True")}}
							</div>
							</form>
						</div>
						<!-- Find & Replace  -->

						<!-- Regex Find & Replace -->
		      			<div class="col-sm-12" style="border-bottom: 1px solid lightgrey; overflow-x: auto;">
							<h5><u><strong>Find and Replace Using Regex</strong></u></h5>
							<form method="post" action="{{ url_for('dataset_pages.transform_findreplaceregex', dataset_id=dataset_info.setid, tablename=table_name) }}">
							{{ findrepl_form.csrf_token }}
							<div class="form-group" style="width: 20%; display: inline-block;">
								{{render_field(regexfindreplace_form.select_attr, class_="form-control")}}
							</div>
							<div class="form-group" style="width: 30%; display: inline-block;">
								{{render_field(regexfindreplace_form.regex, class_="form-control", placeholder="Search Regex")}}
							</div>
							<div class="form-group" style="width: 30%; display: inline-block;">
								{{render_field(regexfindreplace_form.replacement, class_="form-control", placeholder="Replacement")}}  
							</div>
							<p style="display: inline-block;"><input type="submit" id="findrepl" class="btn btn-primary" value="Find and Replace"></p>
							<div class="form-group" style="width: 30%; display: inline-block;">
								{{render_field(regexfindreplace_form.case_sens, class_="checkbox-inline", placeholder="True")}}
							</div>
							</form>
						</div>
						<!-- Regex Find & Replace  -->

						<!-- Delete Outliers -->
		      			<div class="col-sm-12" style="border-bottom: 1px solid lightgrey; overflow-x: auto;">
		      				<h5><u><strong>Delete Outlier</strong></u></h5>
							<form method="post" action="{{ url_for('dataset_pages.transform_deleteOutlier', dataset_id=dataset_info.setid,
								tablename=table_name) }}">
							{{ deleteoutlier_form.csrf_token }}
							<div class="form-group" style="width: 30%; display: inline-block;">
								{{render_field(deleteoutlier_form.select_attr, class_="form-control")}}
							</div>
							<div class="form-group" style="width: 20%; display: inline-block;">
								{{render_field(deleteoutlier_form.select_comparison, class_="form-control")}}
							</div>
							<div class="form-group" style="width: 30%; display: inline-block;">
								{{render_field(deleteoutlier_form.value, class_="form-control", placeholder="Value")}}
							</div>
							<p style="display: inline-block;"><input type="submit" id="delete" class="btn btn-primary" value="Delete Outlier"></p>
							</form>
						</div>
						<!-- Delete Outliers -->

						<!-- Type Conversion -->
						<div class="col-sm-12" style="border-bottom: 1px solid lightgrey; overflow-x: auto;">
							<h5><u><strong>Attribute Type Conversion</strong></u></h5>
							<form method="post" action="{{ url_for('dataset_pages.transform_typeconversion', dataset_id=dataset_info.setid, tablename=table_name) }}">
							{{ typeconversion_form.hidden_tag() }}
							<div class="form-group" style="width: 20%; display: inline-block;">
								{{render_field(typeconversion_form.select_attr, class_="form-control") }}
							</div>
							<div class="form-group" style="width: 20%; display: inline-block;">
								{{render_field(typeconversion_form.new_datatype, class_="form-control") }}
							</div>
							<div class="form-group" style="width: 20%; display: inline-block;" id="char_div">
								{{render_field(typeconversion_form.char_amount, class_="form-control", placeholder="Character Amount") }}
							</div>
							<p style="display: inline-block;"><input type="submit" id="typeconversion" class="btn btn-primary" value="Convert Attribute Type"></p>
							</form>
						</div>
						<!-- Type Conversion -->

		      			<!-- Delete Attribute -->
		      			<div class="col-sm-6" style="border-bottom: 1px solid lightgrey; overflow-x: auto;">
		      				<h5><u><strong>Delete an Attribute</strong></u></h5>
							<form method="post" action="{{ url_for('dataset_pages.transform_deleteattr', dataset_id=dataset_info.setid, tablename=table_name) }}">
							{{ delete_form.csrf_token }}
							<div class="form-group" style="width: 30%; display: inline-block;">
								{{render_field(delete_form.select_attr, class_="form-control")}}
							</div>
							<p style="display: inline-block;"><input type="submit" id="delete" class="btn btn-primary" value="Delete Attribute"></p>
							</form>
						</div>
						<!-- Delete Attribute -->

			      		<!-- One Hot Encoding -->
			      		<div class="col-sm-6" style="border-bottom: 1px solid lightgrey; overflow-x: auto;">
			      			<h5><u><strong>One Hot Encoding</strong></u></h5>
				        	<form method="post" action="{{ url_for('dataset_pages.transform_onehotencoding', dataset_id=dataset_info.setid,
				        	tablename=table_name) }}">
							{{ onehotencodingform.csrf_token }}
							<div class="form-group" style="width: 30%; display: inline-block;">
								{{render_field(onehotencodingform.select_attr, class_="form-control")}}
							</div>
							<p style="display: inline-block;"><input type="submit" id="OHE" class="btn btn-primary" value="One Hot Encode"></p>
							</form>
						</div>
						<!-- One Hot Encoding -->

						<!-- Normalize Using Z-Score -->
						<div class="col-sm-6" style="border-bottom: 1px solid lightgrey; overflow-x: auto;">
							<h5><u><strong>Normalize Using Z-Score</strong></u></h5>
							<form method="post" action="{{ url_for('dataset_pages.transform_zscorenormalisation', dataset_id=dataset_info.setid,
								tablename=table_name) }}">
							{{ zscoreform.csrf_token }}
							<div class="form-group" style="width: 30%; display: inline-block;">
								{{render_field(zscoreform.select_attr, class_="form-control")}}
							</div>
							<p style="display: inline-block;"><input type="submit" id="NUZ" class="btn btn-primary" value="Normalize"></p>
							</form>
						</div>
						<!-- Normalize Using Z-Score -->

						<!-- Fill Nulls Mean -->
		      			<div class="col-sm-6" style="border-bottom: 1px solid lightgrey; overflow-x: auto;">
		      				<h5><u><strong>Fill Nulls - Mean</strong></u></h5>
							<form method="post" action="{{ url_for('dataset_pages.transform_fillNullsMean', dataset_id=dataset_info.setid,
								tablename=table_name) }}">
							{{ fillnullmean_form.csrf_token }}
							<div class="form-group" style="width: 30%; display: inline-block;">
								{{render_field(fillnullmean_form.select_attr, class_="form-control")}}
							</div>
							<p style="display: inline-block;"><input type="submit" id="delete" class="btn btn-primary" value="Fill Nulls Mean"></p>
							</form>
						</div>
						<!-- Fill Nulls Mean -->

						<!-- Fill Nulls Median -->
		      			<div class="col-sm-6" style="border-bottom: 1px solid lightgrey; overflow-x: auto;">
		      				<h5><u><strong>Fill Nulls - Median</strong></u></h5>
							<form method="post" action="{{ url_for('dataset_pages.transform_fillNullsMedian', dataset_id=dataset_info.setid,
								tablename=table_name) }}">
							{{ fillnullmedian_form.csrf_token }}
							<div class="form-group" style="width: 30%; display: inline-block;">
								{{render_field(fillnullmedian_form.select_attr, class_="form-control")}}
							</div>
							<p style="display: inline-block;"><input type="submit" id="delete" class="btn btn-primary" value="Fill Nulls Median"></p>
							</form>
						</div>
						<!-- Fill Nulls Median -->

						<!-- Fill Nulls Custom Value -->
		      			<div class="col-sm-6" style="border-bottom: 1px solid lightgrey; overflow-x: auto;">
		      				<h5><u><strong>Fill Nulls - Custom Value</strong></u></h5>
							<form method="post" action="{{ url_for('dataset_pages.transform_fillNullsCustomValue', dataset_id=dataset_info.setid,
								tablename=table_name) }}">
							{{ fillnullcustom_form.csrf_token }}
							<div class="form-group" style="width: 30%; display: inline-block;">
								{{render_field(fillnullcustom_form.select_attr, class_="form-control")}}
							</div>
							<div class="form-group" style="width: 30%; display: inline-block;">
								{{render_field(fillnullcustom_form.replacement, class_="form-control", placeholder="Replacement")}}
							</div>
							<p style="display: inline-block;"><input type="submit" id="delete" class="btn btn-primary" value="Fill Nulls Custom"></p>
							</form>
						</div>
						<!-- Fill Nulls Median -->

						<!-- Discretize Equal Width -->
		      			<div class="col-sm-6" style="border-bottom: 1px solid lightgrey; overflow-x: auto;">
		      				<h5><u><strong>Discretize with Equal Width</strong></u></h5>
							<form method="post" action="{{ url_for('dataset_pages.transform_discretizeEqualWidth', dataset_id=dataset_info.setid, tablename=table_name) }}">
							{{ discretizeWidth_form.csrf_token }}
							<div class="form-group" style="width: 30%; display: inline-block;">
								{{render_field(discretizeWidth_form.select_attr, class_="form-control")}}
							</div>
							<p style="display: inline-block;"><input type="submit" id="delete" class="btn btn-primary" value="Discretize Equal Width"></p>
							</form>
						</div>
						<!-- Discretize Equal Width  -->

						<!-- Discretize Equal Frequency -->
		      			<div class="col-sm-6" style="overflow-x: auto;">
		      				<h5><u><strong>Discretize with Equal Frequency</strong></u></h5>
							<form method="post" action="{{ url_for('dataset_pages.transform_discretizeEqualFreq', dataset_id=dataset_info.setid, tablename=table_name) }}">
							{{ discretizeFreq_form.csrf_token }}
							<div class="form-group" style="width: 30%; display: inline-block;">
								{{render_field(discretizeFreq_form.select_attr, class_="form-control")}}
							</div>
							<p style="display: inline-block;"><input type="submit" id="delete" class="btn btn-primary" value="Discretize Equal Frequency"></p>
							</form>
						</div>
						<!-- Discretize Equal Frequency  -->		      			
			        </div>
	     		</div>
	    	</div>
	    {% endif %}
  	</div>	

  	<div class="xs-center">
    	<div class="row">
	    	<div class="col-sm-3 text-left">
	    		<input type="text" id="input" placeholder="Search Page No" style="border-style: solid; border-width: 1px; border-radius: 3px;"/>
				<button onclick="page_search()"><i class="glyphicon glyphicon-arrow-right"></i></button>

				<script type="text/javascript">
				function page_search(){
					if(document.getElementById('input').value != "") {
				    	if(!isNaN(document.getElementById('input').value))
				    		window.location.href = '/dataset/{{ dataset_info.setid }}/{{ table_name }}/' + document.getElementById('input').value;
					}
				 }
				</script>
			</div>

	    	<div class="col-sm-6 text-center" style="overflow-x: auto;">
    	   		<ul class="pagination">
    	   			{% if page_indices|length > 1 %}
		    			{% for index in page_indices %}
		    				{% if index == "..." %}
		    					<li class="page-item hidden-xs"><a class="page-link" style="color: black;">...</a></li>
		    				{% else %}
		    					{% if index|int == current_page %}
		    						<style>
		    							.active {
		    								color: red !important;
		    							}
		    						</style>
			    					<li class="page-item active"><a class="page-link" href="{{ url_for('dataset_pages.view_dataset_table', dataset_id=dataset_info.setid, tablename=table_name, page_nr=index) }}" style="color: black;"">
			    						{{ index }}</a></li>
			    				{% else %}
			    					<li class="page-item"><a class="page-link" href="{{ url_for('dataset_pages.view_dataset_table', dataset_id=dataset_info.setid, tablename=table_name, page_nr=index) }}" style="color: black;"">
			    						{{ index }}</a></li>
		    					{% endif %}
		    				{% endif %}
		    			{% endfor %}
		    		{% else %}
			    			<li class="page-item active"><a class="page-link" style="color: black;"">
				    						{{ page_indices[0] }}</a></li>
			    	{% endif %}

	    		</ul>	
		    </div>

		    <div class="col-sm-3 text-right">
		    	<input type="text" id="searchInput" placeholder="Search Entry" style="border-style: solid; border-width: 1px; border-radius: 3px;" />
		    </div>
		</div>
	</div>

	<div class="text-center">
		<style>
			table {
       			border-collapse: collapse;
        		width: 20%;
        		float:left;
				padding:3px;
				border-radius: 3px;
				}

	        td, th {
	         	font-size: 15px;
	            text-align: left;
	            padding: 8px;
	        }

	        table thead {
	        	background-color: lightgrey;
	        }

	        table tbody tr:nth-child(even) {
	        	background-color: #eaeaea;
	        }

	        .dataTables_filter {
	        	display: none;
	        }

		</style>
		<div>
			{{ table_data|safe }}
		</div>
		<script>
			$(document).ready( function () {
    			$('#mytable').DataTable( {
    				scrollX: true,
    				scrollY: true,
    				paging: false,
    				lengthChange: false,
    				bInfo: false
    			} );
    		} );

    		var $rows = $('#mytable tbody tr');
			$('#searchInput').keyup(function() {
			    var val = $.trim($(this).val()).replace(/ +/g, ' ').toLowerCase();
			    
			    $rows.show().filter(function() {
			        var text = $(this).text().replace(/\s+/g, ' ').toLowerCase();
			        return !~text.indexOf(val);
			    }).hide();

			});
		</script>
	</div>

	<script charset="utf-8" type="text/javascript">

		

		$(function() {

			var dropdown = {
				attribute: $('#attribute'),
				options: $('#typeOptions'),
				char_amount: $('#char_amount')
			};

			updateOptions();

			function updateOptions() {

				$('#char_div').hide();

				var send = {
					attribute: dropdown.attribute.val()
				};
				dropdown.options.attr('disabled', 'disabled');
				dropdown.options.empty();
				$.getJSON("{{ url_for('dataset_pages._get_options', dataset_id=dataset_info.setid, tablename=table_name, attr=send) }}", send, function(data) {
					data.forEach(function(item) {
						dropdown.options.append (
							$('<option>', {
								value: item[0],
								text: item[1]
							})
						);
					});
					dropdown.options.removeAttr('disabled');
				});	
			}
			$('#attribute').change(function() {
				updateOptions();
			});

			$('#typeOptions').change(function() {
				if($('#typeOptions option:selected').text() == "CHAR(X)" || $('#typeOptions option:selected').text() == "VARCHAR(X)"){
					$('#char_div').show();
				}
				else {
					$('#char_div').hide();
				}
			});
		});

	</script>

{% endblock %}
